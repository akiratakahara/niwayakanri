# 運用マニュアル

## 目次
1. [初回セットアップ](#初回セットアップ)
2. [ユーザー管理](#ユーザー管理)
3. [申請業務](#申請業務)
4. [承認業務](#承認業務)
5. [よくある質問](#よくある質問)

---

## 初回セットアップ

### 管理者による初期設定

#### 1. システムのインストール

```bash
# バックエンド
cd backend
pip install -r requirements.txt

# フロントエンド
cd frontend
npm install
```

#### 2. 初回セットアップ実行

```bash
cd backend
python setup.py
```

対話式で以下を入力:
- 管理者メールアドレス
- パスワード（8文字以上、英字+数字）
- 管理者名
- 部署（オプション）
- 役職（オプション）

#### 3. サーバー起動

**ターミナル1（バックエンド）:**
```bash
cd backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**ターミナル2（フロントエンド）:**
```bash
cd frontend
npm run dev
```

#### 4. 初回ログイン

1. ブラウザで http://localhost:3000 にアクセス
2. setup.pyで作成した管理者アカウントでログイン

---

## ユーザー管理

### 新規ユーザー登録（管理者のみ）

#### 手順
1. 管理者でログイン
2. 「管理画面」をクリック
3. 「ユーザー登録」をクリック
4. 必要情報を入力:
   - メールアドレス
   - パスワード（8文字以上、英字+数字）
   - 名前
   - 部署（任意）
   - 役職（任意）
   - 役割（admin または user）
5. 「登録」ボタンをクリック

#### 役割の違い

**admin（管理者）:**
- ユーザー登録
- 全申請の閲覧
- 申請の承認/却下
- 管理画面アクセス

**user（一般ユーザー）:**
- 申請の作成・提出
- 自分の申請のみ閲覧
- PDF出力

### ユーザー情報の変更

1. 管理画面 → ユーザー一覧
2. 編集したいユーザーを選択
3. 情報を更新
4. 「更新」をクリック

### ユーザーの無効化

1. ユーザー編集画面
2. 「アクティブ」のチェックを外す
3. 「更新」をクリック

→ 該当ユーザーはログインできなくなります

---

## 申請業務

### 申請の種類

1. **休暇申請**
   - 有給休暇、特別休暇など
   - 開始日・終了日・日数を入力

2. **残業申請**
   - 時間外労働の事前申請
   - 勤務日・開始時刻・終了時刻を入力

3. **休日出勤申請**
   - 休日の勤務申請
   - 代休取得日の指定可能

4. **仮払金申請**
   - 経費の事前支払い申請
   - 現場名・金額を入力

5. **立替金申請**
   - 立替経費の精算申請
   - 明細を複数行入力可能

6. **仮払金精算申請**
   - 仮払金の精算
   - 使用明細と残額を入力

### 申請の作成手順

#### 1. 新規申請作成

1. ダッシュボードにログイン
2. 作成したい申請の「申請」ボタンをクリック
3. フォームに必要事項を入力
4. 以下のいずれかを選択:
   - **下書き保存**: 後で編集可能
   - **申請**: 承認者に提出

#### 2. 下書きの編集

1. ダッシュボードで「下書き」ステータスの申請を選択
2. 内容を編集
3. 「申請」で提出 または 再度「下書き保存」

#### 3. PDF出力

1. 申請詳細画面を開く
2. 「PDFダウンロード」ボタンをクリック
3. A4サイズのPDFがダウンロードされます

### 申請状況の確認

#### ステータスの意味

- **下書き**: 作成中（未提出）
- **申請済み**: 承認待ち
- **承認**: 承認完了
- **却下**: 却下されました

#### 確認方法

1. ダッシュボード
2. 「申請一覧」タブ
3. ステータスで絞り込み可能

---

## 承認業務

### 承認待ち申請の確認

#### 手順
1. 管理者でログイン
2. 「承認管理」をクリック
3. 承認待ち申請の一覧が表示されます

### 申請の承認

1. 承認管理画面で申請を選択
2. 申請内容を確認
3. 「承認」ボタンをクリック
4. コメント入力（任意）
5. 確認

**仮払金申請の場合:**
- 受領日を入力してください

### 申請の却下

1. 申請を選択
2. 「却下」ボタンをクリック
3. 却下理由をコメント欄に入力（推奨）
4. 確認

### 承認後の対応

#### 仮払金申請承認後
- 受領日が記録されます
- 精算申請時に参照されます

#### 精算申請承認後
- 仮払金申請と紐付けられます
- 残額が記録されます

---

## よくある質問

### Q1. パスワードを忘れました
**A:** 管理者に連絡してパスワードをリセットしてもらってください。
管理者は管理画面からユーザー情報を更新できます。

### Q2. 申請を間違えて提出してしまいました
**A:** 管理者に連絡して却下してもらってください。
却下後、正しい内容で再申請してください。

### Q3. PDFが文字化けします
**A:** ブラウザを最新版に更新してください。
Chrome、Edge、Firefoxの最新版を推奨します。

### Q4. スマホから申請できますか？
**A:** はい、可能です。
ブラウザからアクセスしてください。
レスポンシブデザインでスマホ画面に最適化されています。

### Q5. 精算申請の仮払金申請IDがわかりません
**A:** ダッシュボードの仮払金申請一覧で確認できます。
申請IDは申請詳細画面にも表示されています。

### Q6. データをバックアップしたい
**A:** 管理者は以下のファイルをバックアップしてください:
- `backend/niwayakanri.db` （データベース）
- `backend/.env` （設定ファイル）

### Q7. ユーザーを削除したい
**A:** セキュリティのため削除機能はありません。
代わりに「アクティブ」を無効にしてください。
これでログインできなくなります。

### Q8. 承認権限を複数人に付与したい
**A:** 管理画面で複数のユーザーに「admin」役割を設定してください。
全ての管理者が承認・管理業務を行えます。

### Q9. SECRET_KEYを変更したい
**A:** 以下の手順で変更してください:

```bash
# 新しいSECRET_KEYを生成
python -c "import secrets; print(secrets.token_urlsafe(32))"

# .envファイルを編集
# SECRET_KEY=<生成された値>

# サーバー再起動
```

**注意:** SECRET_KEY変更後は全ユーザーが再ログイン必要です。

### Q10. データベースをリセットしたい
**A:** 以下のコマンドで初期化できます:

```bash
cd backend
rm niwayakanri.db  # データベース削除
python setup.py    # 再セットアップ
```

**警告:** 全データが削除されます。事前にバックアップしてください。

---

## トラブルシューティング

### サーバーが起動しない

**症状:** `uvicorn` コマンドでエラー

**対処法:**
1. 依存パッケージを再インストール
   ```bash
   pip install -r requirements.txt
   ```

2. ポート競合を確認
   ```bash
   # 別のポートで起動
   uvicorn app.main:app --port 8001
   ```

### ログインできない

**症状:** 「メールアドレスまたはパスワードが正しくありません」

**対処法:**
1. メールアドレス・パスワードを再確認
2. 管理者に連絡してアクティブ状態を確認
3. データベースを確認:
   ```bash
   cd backend
   python -c "from app.core.database import SessionLocal; from app.models.database import User; db = SessionLocal(); users = db.query(User).all(); print([(u.email, u.is_active) for u in users])"
   ```

### 申請一覧が表示されない

**症状:** ダッシュボードが空

**対処法:**
1. ブラウザのキャッシュをクリア
2. 開発者ツールでコンソールエラーを確認
3. バックエンドのログを確認

---

## 定期メンテナンス

### 週次
- [ ] データベースバックアップ
- [ ] ログファイル確認

### 月次
- [ ] ユーザー一覧の確認（退職者の無効化）
- [ ] 申請データの整理
- [ ] システムログの確認

### 必要時
- [ ] パッケージ更新
- [ ] セキュリティパッチ適用
- [ ] SECRET_KEY ローテーション（年1回推奨）

---

## お問い合わせ

システムに関するご質問・不具合報告は開発チームまでご連絡ください。
